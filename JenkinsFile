pipeline {
  /** ***************
   ** CONFIGURE AGENT
   ** **************/
  agent {
    node {
      // ** Set the node/agent our job should run on.
      label 'ecs_aws_instance'
    }
  }

  /** ***************
   ** ## CONFIG ENV
   * Here we will load the properties file. This injects the Key=Pair
   * as environment variables.
   ** **************/
  environment {
    // Load environment variables from properties file
    REPO = sh(script: 'grep REPO .properties | cut -d= -f2 | tr -d \'"\'', returnStdout: true).trim()
    TAG = sh(script: 'grep TAG .properties | cut -d= -f2 | tr -d \'"\'', returnStdout: true).trim()
    RELEASE = sh(script: 'grep RELEASE .properties | cut -d= -f2 | tr -d \'"\'', returnStdout: true).trim()
    VERSION = sh(script: 'grep VERSION .properties | cut -d= -f2 | tr -d \'"\'', returnStdout: true).trim()
  }

  /**
   * ## PIPELINE
   */
  stages {

    /** ***************
      ** ## Build game package
      ** **************/
    stage("Retrieve game package") {
      steps {
        sh "wget ${REPO}/releases/download/${RELEASE}/${TAG}-${VERSION}.zip"
        sh "sudo mkdir /dist"
        sh "unzip ${TAG}-${VERSION}.zip -d /dist"
      }
    }  

    /** ***************
      ** ## Deploy game package
      ** **************/
    stage("Deploy game package") {
      steps {
        sh "cd /dist"
        sh "cp -r ./ /var/www/html"
      }
    } 
  } 
}