pipeline {


  agent {
    node {
      // ** Set the node/agent our job should run on.
      label 'build_node'
    }
  }

  /**
   * ## PIPELINE
   */
  stages {

    /** ***************
      ** ## Build game package
      ** **************/
    stage("Build package") {
      steps {
        pwsh '''
          npm run build
        '''
      }
    }
    
    stage("Upload package to server") {
      steps {
        pwsh '''
          Compress-Archive -Path ./dist/* -DestinationPath release.zip
          scp release.zip ${env:AWS_USER}@${env:AWS_LINK}:/home/${env:AWS_USER}
        '''
      }
    }

    /** ***************
      ** ## Deploy game package
      ** **************/
    stage("Deploy game package") {

      agent {
        node {
          // ** Set the node/agent our job should run on.
          label 'ecs_aws_instance'
        }
      }

      steps {
        sh "sudo unzip -o ${TAG}-${VERSION}.zip -d /var/www/html"
      }
    } 
  } 
}